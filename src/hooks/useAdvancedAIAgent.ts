
import { useState } from 'react';
import { supabase } from '@/integrations/supabase/client';
import { useTranslation } from 'react-i18next';

export const useAdvancedAIAgent = () => {
  const [isLoading, setIsLoading] = useState(false);
  const [shouldRedirectToForm, setShouldRedirectToForm] = useState(false);
  const { i18n } = useTranslation();

  const sendMessageToAI = async (message: string, conversationHistory: any[] = []) => {
    setIsLoading(true);
    setShouldRedirectToForm(false);
    
    try {
      console.log('Sending message to AI:', message);
      
      // Check for pricing inquiries first
      const lowerMessage = message.toLowerCase();
      if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('ุณุนุฑ') || lowerMessage.includes('ุชูููุฉ') || lowerMessage.includes('budget') || lowerMessage.includes('quote')) {
        setShouldRedirectToForm(true);
        return generatePriceRedirectResponse(i18n.language);
      }

      // Get enhanced company knowledge without pricing
      const [servicesResponse, inquiriesResponse, configResponse] = await Promise.allSettled([
        supabase.from('service_examples').select('*').limit(20),
        supabase.from('inquiries').select('name, inquiry_text, inquiry_type').order('created_at', { ascending: false }).limit(10),
        supabase.from('ai_chat_config').select('*')
      ]);

      const serviceExamples = servicesResponse.status === 'fulfilled' 
        ? servicesResponse.value.data || []
        : [];

      const companyKnowledge = {
        services: [
          'Logo Design - Premium brand identity creation with comprehensive design process',
          'Website Development - Modern, responsive web solutions with latest technologies',
          'E-commerce Solutions - Complete online stores with advanced features',
          'Social Media Management - Full social media presence and engagement',
          'Digital Marketing Campaigns - ROI-focused marketing strategies',
          'Smart CX Systems - AI-powered customer experience solutions',
          'Personal AI Assistants - Business automation and intelligent support',
          'ERP Solutions - Enterprise resource planning systems'
        ],
        serviceExamples: serviceExamples.slice(0, 10),
        paymentMethods: ['Consultation required for payment options'],
        locations: 'Global with focus on Middle East and Arabic-speaking regions',
        languages: ['English', 'Arabic'],
        specialties: [
          'Bilingual Arabic-English content creation',
          'Middle East market expertise',
          'Custom solutions for each client',
          'Comprehensive consultation process'
        ],
        approach: 'We focus on understanding your needs first through detailed consultation before providing customized solutions and quotes.'
      };

      const recentInquiries = inquiriesResponse.status === 'fulfilled' 
        ? inquiriesResponse.value.data || []
        : [];

      const aiConfig = configResponse.status === 'fulfilled' 
        ? configResponse.value.data || []
        : [];

      // Try to use the actual OpenRouter API if key is available
      const storedApiKey = localStorage.getItem('openrouter_api_key');
      
      if (storedApiKey) {
        try {
          const { data, error } = await supabase.functions.invoke('openrouter-ai-chat', {
            body: {
              message,
              conversationHistory,
              language: i18n.language,
              companyKnowledge,
              recentInquiries,
              aiConfig,
              apiKey: storedApiKey
            }
          });

          console.log('Supabase function response:', data, error);

          if (!error && data?.response) {
            return data.response;
          }
        } catch (error) {
          console.log('API call failed, using intelligent fallback:', error);
        }
      }

      // Always use intelligent local responses for better user experience
      return generateIntelligentResponse(message, i18n.language, companyKnowledge, conversationHistory);

    } catch (error) {
      console.error('AI response error:', error);
      return generateIntelligentResponse(message, i18n.language, undefined, conversationHistory);
    } finally {
      setIsLoading(false);
    }
  };

  return {
    sendMessageToAI,
    isLoading,
    shouldRedirectToForm
  };
};

// Enhanced intelligent response generator without pricing
const generateIntelligentResponse = (
  message: string, 
  language: string, 
  companyKnowledge?: any, 
  conversationHistory: any[] = []
) => {
  const lowerMessage = message.toLowerCase();
  const isArabic = language === 'ar';

  // Greeting responses
  if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('ูุฑุญุจุง') || lowerMessage.includes('ุงูุณูุงู')) {
    return isArabic 
      ? `ูุฑุญุจุงู ูุฃููุงู ูุณููุงู! ๐ ุฃูุง ูุณุงุนุฏ DigitalPro ุงูุฐูู

๐ฏ **ูุง ูููุฒูุง:**
โข ุญููู ุฑูููุฉ ูุฎุตุตุฉ ููุจุชูุฑุฉ
โข ูุฑูู ุฎุจุฑุงุก ูุชุฎุตุต ูู ุฃุญุฏุซ ุงูุชูููุงุช
โข ุฎุฏูุฉ ุงุณุชุดุงุฑูุฉ ุดุงููุฉ ููุฌุงููุฉ
โข ูุชุงุฆุฌ ูุถูููุฉ ููุงุจูุฉ ููููุงุณ

๐ **ุฎุฏูุงุชูุง ุงูุฑุฆูุณูุฉ:**
โข ุชุตููู ุงูุดุนุงุฑุงุช - ูููุงุช ุจุตุฑูุฉ ูููุฒุฉ ููุง ุชููุณู
โข ุชุทููุฑ ุงูููุงูุน - ููุงูุน ุญุฏูุซุฉ ูุณุฑูุนุฉ
โข ุงููุชุงุฌุฑ ุงูุฅููุชุฑูููุฉ - ุญููู ุชุฌุงุฑุฉ ูุชูุงููุฉ
โข ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุชูุงุตู - ููู ูุถููู ูุชูุงุนู ุนุงูู
โข ุงูุชุณููู ุงูุฑููู - ุงุณุชุฑุงุชูุฌูุงุช ููู ูุนุงูุฉ
โข ุฃูุธูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู - ุชูููุงุช ุงููุณุชูุจู

๐ก **ููุฌูุง:**
ูุจุฏุฃ ุจููู ุงุญุชูุงุฌุงุชู ูู ุฎูุงู ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ ููุตูุฉุ ุซู ููุฏู ุญููู ูุฎุตุตุฉ ุชูุงูุงู ููุดุฑูุนู.

ูุง ุงูุฎุฏูุฉ ุงูุชู ุชูููุ ุฃู ุชูุถู ุงูุจุฏุก ุจุฌูุณุฉ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉุ โจ`
      : `Hello and welcome! ๐ I'm DigitalPro's intelligent assistant

๐ฏ **What sets us apart:**
โข Custom and innovative digital solutions
โข Expert team specializing in latest technologies
โข Comprehensive free consultation service
โข Guaranteed and measurable results

๐ **Our Core Services:**
โข Logo Design - Distinctive and memorable visual identities
โข Website Development - Modern and fast websites
โข E-commerce Solutions - Complete commerce solutions
โข Social Media Management - Guaranteed growth and high engagement
โข Digital Marketing - Effective growth strategies
โข AI Systems - Future technologies

๐ก **Our Approach:**
We start by understanding your needs through a detailed free consultation, then provide completely customized solutions for your project.

Which service interests you? Or would you prefer to start with a free consultation? โจ`;
  }

  // Service-specific responses without pricing
  if (lowerMessage.includes('logo') || lowerMessage.includes('ุดุนุงุฑ')) {
    return isArabic
      ? `๐จ **ุชุตููู ุงูุดุนุงุฑุงุช - ุฎุจุฑุชูุง ูุดุบููุง!**

**๐ ุนูููุชูุง ุงูุฅุจุฏุงุนูุฉ:**
1๏ธโฃ **ุงูุจุญุซ ูุงูุชุญููู** - ุฏุฑุงุณุฉ ุนูููุฉ ููุฌุงู ุนููู ูููุงูุณูู
2๏ธโฃ **ุงูุนุตู ุงูุฐููู** - ุฌูุณุงุช ุฅุจุฏุงุนูุฉ ูุน ูุฑูู ุงูุชุตููู
3๏ธโฃ **ุงูุชุตููู ุงูุฃููู** - 3-5 ููุงููู ุฃูููุฉ ูุฎุชููุฉ
4๏ธโฃ **ุงูุชุทููุฑ ูุงูุชุญุณูู** - ุชุนุฏููุงุช ุบูุฑ ูุญุฏูุฏุฉ
5๏ธโฃ **ุงูุชุณููู ุงูููุงุฆู** - ุฌููุน ุงููููุงุช ุจุฃุนูู ุฌูุฏุฉ

**๐ ูุง ุชุญุตู ุนููู:**
โข ุดุนุงุฑ ูุฑูุฏ 100% (ููุณ ูุงูุจ ุฌุงูุฒ!)
โข ุชุนุฏููุงุช ุบูุฑ ูุญุฏูุฏุฉ ุญุชู ุงูุฑุถุง ุงูุชุงู
โข ุฌููุน ุงูุชูุณููุงุช (PNG, SVG, AI, PDF, EPS)
โข ุฏููู ุฅุฑุดุงุฏุงุช ุงูุนูุงูุฉ ุงูุชุฌุงุฑูุฉ ุงููุงูู

ูู ุชูุฏ ูุนุฑูุฉ ุงููุฒูุฏ ุนู ุนูููุชูุง ุฃู ุชูุถู ุงูุจุฏุก ุจุฌูุณุฉ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ ูููุงูุดุฉ ูุดุฑูุนูุ ๐ฏ`
      : `๐จ **Logo Design - Our Expertise & Passion!**

**๐ Our Creative Process:**
1๏ธโฃ **Research & Analysis** - Deep study of your industry & competitors
2๏ธโฃ **Brainstorming** - Creative sessions with our design team
3๏ธโฃ **Initial Design** - 3-5 different initial concepts
4๏ธโฃ **Development & Refinement** - Unlimited revisions
5๏ธโฃ **Final Delivery** - All files in highest quality

**๐ What You Get:**
โข 100% unique logo (not a template!)
โข Unlimited revisions until perfect satisfaction
โข All formats (PNG, SVG, AI, PDF, EPS)
โข Complete brand guideline documentation

Would you like to know more about our process or prefer to start with a free consultation to discuss your project? ๐ฏ`;
  }

  // Default intelligent response
  return isArabic
    ? `ุดูุฑุงู ูู ุนูู ุชูุงุตูู ูุนูุง! ๐ 

ุฃูุง ููุง ููุณุงุนุฏุชู ูู ุชุญููู ุฃูุฏุงูู ุงูุฑูููุฉ ุจุฃุญุฏุซ ุงูุชูููุงุช ูุงูุญููู ุงููุจุชูุฑุฉ.

๐ฏ **ูููููู ูุณุงุนุฏุชู ูู:**
โข ููู ุฎุฏูุงุชูุง ุงููุฎุชููุฉ
โข ุชุญุฏูุฏ ุงูุญู ุงูุฃูุซู ูุงุญุชูุงุฌุงุชู
โข ุชุฑุชูุจ ุฌูุณุฉ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ
โข ุงูุฅุฌุงุจุฉ ุนูู ุฌููุน ุฃุณุฆูุชู

๐ฌ **ุฃุฎุจุฑูู ุนู:**
- ููุน ุนููู ุฃู ูุดุฑูุนู
- ุงูุชุญุฏูุงุช ุงูุชู ุชูุงุฌููุง
- ุฃูุฏุงูู ุงููุณุชูุจููุฉ

ุณุฃููู ุจุชูุฌููู ููุญู ุงูุฃูุซู ูุชุฑุชูุจ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ ูุน ูุฑูููุง ุงููุชุฎุตุต! ๐`
    : `Thank you for reaching out! ๐

I'm here to help you achieve your digital goals with the latest technologies and innovative solutions.

๐ฏ **I can help you with:**
โข Understanding our different services
โข Identifying the optimal solution for your needs
โข Arranging a free consultation
โข Answering all your questions

๐ฌ **Tell me about:**
- Your business or project type
- Challenges you're facing
- Your future goals

I'll guide you to the optimal solution and arrange a free consultation with our specialized team! ๐`;
};

// Generate price redirect response
const generatePriceRedirectResponse = (language: string) => {
  return language === 'ar'
    ? `ุฃููู ุงูุชูุงูู ุจูุนุฑูุฉ ุงูุชูุงุตูู ุงููุงููุฉ! ๐ผ

ูุญู ูุคูู ุจุชูุฏูู ุนุฑูุถ ูุฎุตุตุฉ ุชูุงุณุจ ุงุญุชูุงุฌุงุชู ุชูุงูุงูุ ูุฐูู ููุถู ุฃููุงู ููู ูุดุฑูุนู ุจุงูุชูุตูู.

๐ฏ **ููุงุฐุง ูุชุจุน ูุฐุง ุงูููุฌุ**
โข ูู ูุดุฑูุน ูุฑูุฏ ููุชุทูุจุงุชู ูุฎุชููุฉ
โข ูุฑูุฏ ุชูุฏูู ุฃูุถู ูููุฉ ููุงุจู ุงุณุชุซูุงุฑู
โข ูุถูู ุนุฏู ุฏูุนู ููุงุจู ุฎุฏูุงุช ูุง ุชุญุชุงุฌูุง

๐ **ุงูุฎุทูุฉ ุงูุชุงููุฉ:**
ุณุฃุณุงุนุฏู ูู ููู ุงุญุชูุงุฌุงุชู ูุชุฑุชูุจ ุฌูุณุฉ ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ ูุน ูุฑูููุงุ ูุณูููููู ุจุชูุฏูู ุนุฑุถ ููุตู ููุฎุตุต ุฎูุงู 24 ุณุงุนุฉ.

ูู ุชูุฏ ุงูุจุฏุก ูู ููุงูุดุฉ ูุดุฑูุนูุ`
    : `I understand your interest in the financial details! ๐ผ

We believe in providing customized proposals that perfectly match your needs, so we prefer to first understand your project in detail.

๐ฏ **Why do we follow this approach?**
โข Every project is unique with different requirements
โข We want to provide the best value for your investment
โข We ensure you don't pay for services you don't need

๐ **Next Step:**
I'll help you understand your needs and arrange a free consultation with our team, and they'll provide a detailed, customized proposal within 24 hours.

Would you like to start discussing your project?`;
};
